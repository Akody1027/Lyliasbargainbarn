<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase App (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <!-- Firestore (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- PayPal SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=AXFMhUc3S_3ohWhmBYldq&currency=USD"></script>
  <style>
#sidebar {
  width: 35vw;
  max-width: 35vw;
  min-width: 200px;
  overflow: hidden;
}

#dashboard-separator {
  width: 90%;
  height: 1.5px; /* thin line */
  background-color: #888888; /* medium gray */
  margin: 0.3rem auto 1rem auto; /* top margin to separate from button, bottom margin for spacing */
  border-radius: 1px; /* slight rounding */
}

    

.customer-btn {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
  display: block;
  border-radius:2px;
  font-weight:700;
}
.customer-btn.active {
  background-color: #f0f0f0;
  color: black;
  font-weight:900;
  border-radius:3px;
}

    
    #invoice-container {
      max-width: 800px;
      margin: 2rem auto 0 auto;
      position: relative;
      display: none;
    }
    #invoice-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
      gap: 0.4rem;
      user-select: none;
    }
    .grid-cell {
      aspect-ratio: 1/1;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #CBD5E0;
      border-radius: 0.25rem;
      background: #fff;
      color: #1A202C;
      font-size: 0.75rem;
      font-weight: 700;
      cursor: pointer;
      position: relative;
      padding: 0.1rem;
      transition: box-shadow 0.12s;
    }
    .grid-cell.red {
      background: #fecaca;
      border-color: #fecaca;
      color: #b91c1c;
    }
    .grid-cell.green {
      background: #bbf7d0;
      border-color: #bbf7d0;
      color: #166534;
    }
    .grid-cell.selected {
      outline: 3px solid #000;
      z-index: 10;
    }

    #batch-bar {
      background: #f3f4f6;
      border: 2px solid #000;
      border-radius: 0.5rem;
      box-shadow: 0 4px 24px #3332;
      color: #333;
      font-weight: 600;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s ease;
      margin-top: 0.5rem;
      padding: 3rem 1rem 1rem 1rem;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    #batch-bar.show {
      visibility: visible;
      opacity: 1;
    }
    #batch-clear {
      position: absolute;
      top: 8px;
      right: 8px;
      background: transparent !important;
      border: none;
      color: #ef4444;
      font-weight: 700;
      font-size: 1.5rem;
      line-height: 1;
      cursor: pointer;
      user-select: none;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0;
      transition: color 0.2s ease;
      z-index: 10;
    }
    #batch-clear:hover {
      color: #b91c1c;
    }
    .bar-actions {
      display: flex;
      gap: 1rem;
      flex-grow: 1;
      justify-content: flex-end;
    }
    .bar-actions button {
      flex: 1.2;
      cursor: pointer;
      font-weight: 600;
      padding: 0.5rem 0;
      border-radius: 0.5rem;
      border: none;
      font-size: 1rem;
      background: #9ca3af;
      color: black;
      transition: background 0.2s ease;
      user-select: none;
    }
    .bar-actions button:hover {
      filter: brightness(0.9);
    }

    #login-overlay {
      z-index: 9999;
    }

    .email-check {
      color: #22c55e;
      font-size: 1.15em;
      margin-left: 5px;
      vertical-align: middle;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .email-check.show {
      opacity: 1;
    }

    /* New Email Options Dropdown */
    #email-options-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      max-width: 380px;
      background: white;
      border: 2px solid black; /* thinner border */
      border-radius: 0.5rem; /* less rounded corners */
      padding: 0.75rem 1rem 1rem 1rem;
      z-index: 2000;
      display: none;
      flex-direction: column;
      justify-content: space-between;
      height: 110px;
    }
    #email-options-dropdown.show {
      display: flex;
    }
    #email-options-dropdown h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
      font-weight: 600;
      color: black;
      user-select: none;
    }
    #email-options-dropdown .options-buttons {
      display: flex;
      gap: 0.75rem;
      justify-content: space-between;
      margin-top: auto; /* push buttons to bottom */
    }
    #email-options-dropdown button {
      flex: 1;
      padding: 0.3rem 0;
      border-radius: 0.5rem;
      border: none;
      font-weight: 600;
      font-size: .95rem;
      cursor: pointer;
      user-select: none;
      background: #9ca3af;
      color: black;
      transition: background 0.2s ease;
    }
    #email-options-dropdown button:hover {
      filter: brightness(0.9);
    }
    #email-options-dropdown .close-btn {
      position: absolute;
      top: 6px;
      right: 8px;
      font-size: 1.3rem;
      font-weight: 700;
      color: #ef4444;
      cursor: pointer;
      user-select: none;
      background: transparent !important;
      border: none;
      padding: 0;
      line-height: 1;
    }
    #email-options-dropdown .close-btn:hover {
      color: #b91c1c;
    }

#sidebar-customer-list {
  max-height: calc(100vh - 160px);
  overflow-y: auto;
  padding-right: 0.5rem; /* prevent scrollbar overlap */
}

    /* New styling for warning ! */
    .customer-warning {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #ef4444; /* red background */
      color: white; /* black text */
      font-weight: 900;
      font-size: 1rem;
      border-radius: 9999px; /* fully rounded circle */
      width: 15px;
      height: 15px;
      position: absolute;
      right: 0px; /* far right within sidebar */
      top: 50%;
      transform: translateY(-50%);
      user-select: none;
      pointer-events: none;
    }
    .sidebar-customer-item {
      position: relative;
      padding-right: 5px; /* space to right for warning circle */
    }
  </style>
</head>
<body class="flex h-screen bg-gray-50">

  <!-- Login Overlay -->
  <div id="login-overlay" class="absolute inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50">
    <div class="bg-white rounded-2xl p-8 shadow-lg w-full max-w-sm">
      <h2 class="text-2xl font-semibold mb-4 text-gray-800">Admin Login</h2>
      <input id="admin-pin" type="password" maxlength="4" placeholder="4-digit PIN"
             class="w-full p-4 border-2 rounded-lg mb-4 text-xl focus:outline-none focus:border-gray-300" />
      <button id="login-btn" class="w-full py-4 bg-gray-200 text-black rounded-lg hover:bg-gray-300
                                  flex justify-center items-center text-lg font-semibold transition">
        <span id="login-btn-text">Login</span>
        <span id="login-btn-spinner" class="spinner hidden"></span>
      </button>
      <p id="pin-error" class="mt-2 text-red-600"></p>
    </div>
  </div>

  <!-- Email Modal -->
  <div id="email-modal-bg" class="hidden fixed inset-0 z-1000 bg-[rgba(31,41,55,0.7)] flex justify-center items-center">
    <div id="email-modal" class="bg-white rounded-2xl max-w-[90vw] w-[400px] shadow-lg p-8 relative border-4 border-black overflow-auto">
      <div id="close-email-modal" class="close-modal absolute top-3 right-4 cursor-pointer text-2xl font-bold text-red-600 hover:text-red-800">&times;</div>
      <h2 class="text-2xl font-bold mb-4 text-pink-700">Send Mass Email</h2>
      <div id="email-modal-list" class="mb-4">
        <strong class="block mb-1 text-gray-700">Sending to:</strong>
        <ul id="modal-customers-list" class="mb-3 pl-4 list-disc text-pink-700"></ul>
      </div>
      <form id="mass-email-form" class="flex flex-col gap-3">
        <label class="block text-gray-600 font-semibold mb-1">From:</label>
        <input type="email" readonly value="Laramos@cox.net"
               class="mb-2 bg-gray-100 px-3 py-2 rounded border border-gray-300 text-gray-600" />
        <label class="block text-gray-600 font-semibold mb-1">Subject:</label>
        <input id="email-subject" class="mb-2 px-3 py-2 rounded border border-gray-300" value="Your Invoice from Admin" />
        <label class="block text-gray-600 font-semibold mb-1">Message:</label>
        <textarea id="email-body" placeholder="Write your message..." class="mb-3 px-3 py-2 rounded border border-gray-300 min-h-[120px]">Dear Customer,

Your personalized payment link and PIN will be provided here.

Thank you,
Admin</textarea>
        <button type="submit" class="bg-gray-300 hover:bg-gray-400 text-black font-semibold py-2 rounded-lg">
          Send Email
        </button>
      </form>
      <div id="email-modal-feedback" class="mt-2 text-green-600 font-semibold"></div>
    </div>
  </div>

  <!-- Sidebar -->
  <nav id="sidebar" class="hidden flex-shrink-0 flex-col bg-white p-4 shadow-lg">
    <h1 class="mb-4 text-2xl font-bold">Admin</h1>
    <button data-target="dashboard"
            class="nav-link mb-2 flex w-full items-center rounded px-2 py-1 text-left text-gray-700 hover:bg-gray-100">
      Dashboard
    </button>
    
<div id="dashboard-separator"></div>
    
    <div class="sidebar-divider"></div>
    <div class="mb-2 flex items-center">
      <span class="text-gray-700">👥 Customers</span>
      <button id="add-cust-icon" class="ml-2 rounded bg-gray-200 px-2 py-1">+</button>
    </div>
    <ul id="sidebar-customer-list" class="space-y-1 text-gray-600"></ul>
  </nav>

  <!-- Main Content -->
  <div id="main" class="hidden flex flex-1 flex-col">
    <header class="bg-white shadow-md">
      <div class="px-4 py-3">
        <h2 id="page-title" class="text-xl font-semibold">Dashboard</h2>
      </div>
    </header>
    <main class="mx-auto flex-1 max-w-4xl overflow-auto p-6 space-y-6 w-full">
      <!-- Dashboard Panels -->
      <section id="dashboard" class="space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="rounded-2xl bg-white p-6 shadow">
            <p class="text-sm text-gray-500">Total Customers</p>
            <p id="customersCount" class="text-3xl font-bold">0</p>
          </div>
          <div class="rounded-2xl bg-white p-6 shadow">
            <p class="text-sm text-gray-500">Outstanding Invoices</p>
            <p id="outstandingCount" class="text-3xl font-bold">0</p>
          </div>
          <div class="rounded-2xl bg-white p-6 shadow">
            <p class="text-sm text-gray-500">Unpaid Amount Due</p>
            <p id="unpaidAmount" class="text-3xl font-bold">$0.00</p>
          </div>
          <div class="rounded-2xl bg-white p-6 shadow">
            <p class="text-sm text-gray-500">Revenue This Month</p>
            <p id="revenueCount" class="text-3xl font-bold">$0.00</p>
          </div>
        </div>

        <!-- Invoice Tracking Calendar -->
        <section id="invoice-container" class="space-y-2 relative" style="max-width: 380px; margin-top: 1rem;">
          <h3 class="text-lg font-semibold">Invoice Tracking Calendar</h3>
          <div id="invoice-grid"></div>
          <div id="batch-bar" class="">
            <button id="batch-clear" title="Deselect All">&times;</button>
            <div class="bar-actions">
              <button id="batch-email">Send Email</button>
              <button id="batch-paid">Mark All Paid</button>
            </div>
          </div>

          <!-- New Email Options Dropdown -->
          <div id="email-options-dropdown" aria-hidden="true">
            <button class="close-btn" id="close-email-options">&times;</button>
            <h3>Email Options</h3>
            <div class="options-buttons">
              <button id="email-new-customer">New Customer</button>
              <button id="email-new-invoice">New Invoice</button>
            </div>
          </div>
        </section>
      </section>

      <!-- Add Customer -->
      <section id="customers" class="hidden space-y-8">
        <div class="mx-auto max-w-md rounded-2xl bg-white p-6 shadow">
          <h3 class="mb-4 text-xl font-semibold">+ Add Customer</h3>
          <input id="cust-id" placeholder="Customer ID" class="mb-4 w-full rounded-lg border p-4" />
          <input id="cust-name" placeholder="Customer Name" class="mb-4 w-full rounded-lg border p-4" />
          <input id="cust-email" type="email" placeholder="Customer Email (optional)" class="mb-4 w-full rounded-lg border p-4" />
          <input id="cust-phone" type="tel" placeholder="Phone Number (optional)" class="mb-4 w-full rounded-lg border p-4" />
          <input id="cust-address" placeholder="Address (optional)" class="mb-4 w-full rounded-lg border p-4" />
          <button id="add-cust-btn" class="w-full rounded-lg bg-gray-300 py-3 text-black hover:bg-gray-400">Add Customer</button>
        </div>
      </section>

      <!-- Profile -->
      <section id="profile" class="hidden space-y-6">
        <div class="mx-auto max-w-md space-y-4 rounded-2xl bg-white p-6 shadow">
          <h3 class="text-xl font-semibold">Customer Profile</h3>
          <p><strong>ID:</strong> <span id="profile-id"></span></p>
          <p><strong>Name:</strong> <span id="profile-name"></span></p>
          <p><strong>Email:</strong> <span id="profile-email"></span></p>
          <p><strong>Phone:</strong> <span id="profile-phone"></span></p>
          <p><strong>Address:</strong> <span id="profile-address"></span></p>
          <p><strong>Admin PIN:</strong> <span id="profile-admin-pin"></span></p>
          <p><strong>Customer PIN:</strong> <span id="profile-pin"></span> <button id="reset-pin-btn" class="text-red-600 hover:text-red-800 text-sm font-semibold ml-2">Reset</button></p>
          <input id="invoice-amount" type="number" placeholder="Invoice Amount" class="mb-2 w-full rounded-lg border p-2" />
          <button id="add-invoice-btn" class="w-full rounded-lg bg-gray-300 py-2 text-black hover:bg-gray-400">Add Invoice</button>
          <ul id="profile-bills-list" class="space-y-2 pt-4"></ul>
          <div class="flex flex-row gap-2 mt-4">
            <button id="update-cust-btn" class="flex-1 rounded-lg bg-gray-300 py-2 text-black hover:bg-gray-400">Edit</button>
            <button id="delete-cust-btn" class="flex-1 rounded-lg bg-red-500 py-2 text-white hover:bg-red-600">Delete Customer</button>
          </div>
          <div id="update-fields" class="update-fields"></div>
          <div id="profile-email-log" class="mt-4"></div>
        </div>
      </section>
    </main>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async function () {
      const firebaseConfig = {
        apiKey: "AIzaSyB2lKzEGU4YWV9-E9XILI3Gy0v80F2hJFc",
        authDomain: "customerportal-3032d.firebaseapp.com",
        projectId: "customerportal-3032d",
        storageBucket: "customerportal-3032d.appspot.com",
        messagingSenderId: "1003504088676",
        appId: "1:1003504088676:web:43453e986312257b2f5171",
        measurementId: "G-CVC0HK0WP8",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      function generateUniquePin(existingPins) {
        let pin,
          tries = 0;
        do {
          pin = String(Math.floor(1000 + Math.random() * 9000));
          tries++;
          if (tries > 5000) throw new Error("Could not generate unique PIN");
        } while (existingPins.includes(pin));
        return pin;
      }
      async function getCustomers() {
        const snap = await db.collection("customers").get();
        return snap.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
      }
      async function getBills() {
        const snap = await db.collection("bills").get();
        return snap.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
      }
      function getEmailLog() {
        try {
          return JSON.parse(localStorage.getItem("emailLog") || "{}");
        } catch (e) {
          return {};
        }
      }
      function saveEmailLog(log) {
        try {
          localStorage.setItem("emailLog", JSON.stringify(log));
        } catch (e) {}
      }

      const loginOverlay = document.getElementById("login-overlay");
      const loginBtn = document.getElementById("login-btn");
      const loginBtnText = document.getElementById("login-btn-text");
      const loginBtnSpinner = document.getElementById("login-btn-spinner");
      const pinInput = document.getElementById("admin-pin");
      const pinError = document.getElementById("pin-error");
      const sidebar = document.getElementById("sidebar");
      const main = document.getElementById("main");
      const navLinks = document.querySelectorAll(".nav-link");
      const sidebarCustomerList = document.getElementById("sidebar-customer-list");
      const addCustIcon = document.getElementById("add-cust-icon");
      const addCustBtn = document.getElementById("add-cust-btn");
      const addInvoiceBtn = document.getElementById("add-invoice-btn");
      const deleteCustBtn = document.getElementById("delete-cust-btn");
      const updateCustBtn = document.getElementById("update-cust-btn");
      const updateFieldsDiv = document.getElementById("update-fields");
      const batchBar = document.getElementById("batch-bar");
      const batchPaidBtn = document.getElementById("batch-paid");
      const batchEmailBtn = document.getElementById("batch-email");
      const batchClearBtn = document.getElementById("batch-clear");
      const invoiceGrid = document.getElementById("invoice-grid");
      const invoiceContainer = document.getElementById("invoice-container");
      const emailModalBg = document.getElementById("email-modal-bg");

      const emailOptionsDropdown = document.getElementById("email-options-dropdown");
      const closeEmailOptionsBtn = document.getElementById("close-email-options");
      const emailNewCustomerBtn = document.getElementById("email-new-customer");
      const emailNewInvoiceBtn = document.getElementById("email-new-invoice");

      let activeCustomer = null;
      let selectedCustomerIds = new Set();
      let editMode = false;

      function showSection(id) {
        ["dashboard", "customers", "profile"].forEach((s) => {
          document.getElementById(s).style.display = s === id ? "block" : "none";
        });
        document.getElementById("page-title").textContent = id.charAt(0).toUpperCase() + id.slice(1);
        if (id !== "profile") document.querySelectorAll(".customer-btn").forEach((b) => b.classList.remove("active"));
        invoiceContainer.style.display = id === "dashboard" ? "block" : "none";
      }

      navLinks.forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          navLinks.forEach((l) => l.classList.remove("active"));
          link.classList.add("active");
          showSection(link.getAttribute("data-target"));
        });
      });

      function customerHasMissingInfo(c) {
        if (!c.name || c.name.trim() === "") return false;
        return !c.email || !c.phone || !c.address;
      }

      async function populateSidebar() {
        const emailLog = getEmailLog();
        sidebarCustomerList.innerHTML = "";
        const customers = await getCustomers();
        customers
          .sort((a, b) => +a.id - +b.id)
          .forEach((c) => {
            if (!c.id) return;
            const li = document.createElement("li");
            li.classList.add("sidebar-customer-item");

            const btn = document.createElement("button");
            btn.className = "customer-btn flex items-center justify-between truncate";
            btn.textContent = `${c.id} - ${c.name}`;

            if (customerHasMissingInfo(c)) {
              const warning = document.createElement("span");
              warning.className = "customer-warning";
              warning.title = "Missing info";
              warning.textContent = "!";
              btn.appendChild(warning);
            }

            const emailCheck = document.createElement("span");
            emailCheck.className = "email-check";
            emailCheck.innerHTML = "&#10003;";

            if (emailLog[c.id]) {
              emailCheck.style.opacity = "0";
            }

            btn.appendChild(emailCheck);

            btn.onclick = () => openCustomer(c.id);
            li.appendChild(btn);
            sidebarCustomerList.appendChild(li);
          });
      }

      async function openCustomer(id) {
        const customers = await getCustomers();
        activeCustomer = customers.find((c) => c.id === id);
        if (!activeCustomer) return;
        editMode = false;
        updateCustBtn.textContent = "Edit";
        // Display all fields as text spans
        ["id", "name", "email", "phone", "address"].forEach((f) => {
          const el = document.getElementById("profile-" + f);
          el.textContent = activeCustomer[f] || "";
          el.contentEditable = false;
          el.style.border = "";
          el.style.padding = "";
          el.style.display = "inline";
          // Remove any input fields if left over
          const existingInput = document.getElementById("input-" + f);
          if (existingInput) existingInput.remove();
        });
        document.getElementById("profile-admin-pin").textContent = activeCustomer.adminPin || "";
        document.getElementById("profile-pin").textContent = activeCustomer.pin || "";
        await renderBills();
        renderEmailLog();
        navLinks.forEach((l) => l.classList.remove("active"));
        document.querySelectorAll(".customer-btn").forEach((b) => {
          const text = b.textContent.replace("!", "").replace("✓", "").trim();
          if (text.startsWith(activeCustomer.id + " -")) b.classList.add("active");
          else b.classList.remove("active");
        });
        showSection("profile");
        updateFieldsDiv.innerHTML = "";
      }

      function renderEmailLog() {
        const log = getEmailLog();
        const div = document.getElementById("profile-email-log");
        div.innerHTML =
          activeCustomer && log[activeCustomer.id]
            ? `<div class="log-entry">Last emailed: <span class="dt">${log[activeCustomer.id]}</span></div>`
            : "";
      }

      async function renderBills() {
        const listEl = document.getElementById("profile-bills-list");
        listEl.innerHTML = "";
        const bills = await getBills();
        bills
          .filter((b) => b.customerId === activeCustomer.id)
          .forEach((b) => {
            const li = document.createElement("li");
            li.className = "p-4 bg-gray-100 rounded";
            li.innerHTML = `<p><strong>Amount:</strong> $${b.amount}</p>
                            <p><strong>Due:</strong> ${b.dueDate}</p>
                            <p><strong>Status:</strong> ${b.paid ? "Paid" : "Unpaid"}</p>`;
            if (!b.paid) {
              const payBtn = document.createElement("button");
              payBtn.textContent = "Mark Paid";
              payBtn.className = "mt-2 bg-green-400 text-white px-3 py-1 rounded";
              payBtn.onclick = async () => {
                await db.collection("bills").doc(b.id).update({ paid: true });
                await renderBills();
                await updateMetrics();
                await updateGrid();
              };
              li.appendChild(payBtn);
            }
            listEl.appendChild(li);
          });
      }

      addCustIcon.onclick = () => showSection("customers");
      addCustBtn.onclick = async () => {
        const id = document.getElementById("cust-id").value.trim();
        const name = document.getElementById("cust-name").value.trim();
        if (!id || !name) {
          alert("ID and name required");
          return;
        }
        const pins = (await getCustomers()).map((c) => c.pin);
        const pin = generateUniquePin(pins);
        await db.collection("customers").doc(id).set({
          id,
          name,
          email: document.getElementById("cust-email").value.trim(),
          phone: document.getElementById("cust-phone").value.trim(),
          address: document.getElementById("cust-address").value.trim(),
          pin,
          adminPin: pin // store adminPin equal to pin initially
        });
        ["cust-id", "cust-name", "cust-email", "cust-phone", "cust-address"].forEach(
          (f) => (document.getElementById(f).value = "")
        );
        await populateSidebar();
        await updateMetrics();
        await updateGrid();
        showSection("dashboard");
      };

      addInvoiceBtn.onclick = async () => {
        if (!activeCustomer) {
          alert("Select a customer");
          return;
        }
        const amt = document.getElementById("invoice-amount").value.trim();
        if (!amt) {
          alert("Enter amount");
          return;
        }
        const due = new Date().toISOString().slice(0, 10);
        await db.collection("bills").add({
          customerId: activeCustomer.id,
          amount: parseFloat(amt),
          dueDate: due,
          paid: false,
          createdAt: new Date().toISOString(),
        });
        document.getElementById("invoice-amount").value = "";
        await renderBills();
        await updateMetrics();
        await updateGrid();
      };

      deleteCustBtn.onclick = async () => {
        if (!activeCustomer) {
          alert("Select a customer");
          return;
        }
        if (!confirm(`Delete "${activeCustomer.name}" and all their invoices?`)) return;

        // Update the customer doc by clearing all fields instead of deleting the document
        await db.collection("customers").doc(activeCustomer.id).update({
          name: "",
          email: "",
          phone: "",
          address: "",
          pin: "",
          adminPin: ""
        });

        // Delete all bills related to this customer
        const snap = await db.collection("bills").where("customerId", "==", activeCustomer.id).get();
        const batch = db.batch();
        snap.forEach((d) => batch.delete(d.ref));
        await batch.commit();

        activeCustomer = null;
        ["profile-id", "profile-name", "profile-email", "profile-phone", "profile-address", "profile-pin", "profile-admin-pin"].forEach(
          (f) => (document.getElementById(f).textContent = "")
        );
        document.getElementById("profile-bills-list").innerHTML = "";
        await populateSidebar();
        await updateMetrics();
        await updateGrid();
        showSection("dashboard");
      };

      updateCustBtn.onclick = async () => {
        if (!activeCustomer) return;

        if (!editMode) {
          // Switch to edit mode
          editMode = true;
          updateCustBtn.textContent = "Save";

          // Replace text spans with inputs prefilled with current data
          ["name", "email", "phone", "address"].forEach((f) => {
            const span = document.getElementById("profile-" + f);
            const val = span.textContent;
            span.style.display = "none";
            const input = document.createElement("input");
            input.type = f === "email" ? "email" : f === "phone" ? "tel" : "text";
            input.id = "input-" + f;
            input.value = val;
            input.className = "border rounded px-2 py-1 w-full";
            span.parentNode.insertBefore(input, span.nextSibling);
          });
        } else {
          // Save mode
          const updates = {};
          let hasError = false;
          ["name", "email", "phone", "address"].forEach((f) => {
            const input = document.getElementById("input-" + f);
            if (!input) return;
            const val = input.value.trim();
            if (f === "name" && val === "") {
              alert("Name cannot be empty");
              hasError = true;
              return;
            }
            updates[f] = val;
          });
          if (hasError) return;

          try {
            await db.collection("customers").doc(activeCustomer.id).update(updates);
            Object.assign(activeCustomer, updates);

            // Update UI
            ["name", "email", "phone", "address"].forEach((f) => {
              const span = document.getElementById("profile-" + f);
              const input = document.getElementById("input-" + f);
              span.textContent = updates[f];
              span.style.display = "inline";
              if (input) input.remove();
            });

            editMode = false;
            updateCustBtn.textContent = "Edit";

            await populateSidebar();
            await updateMetrics();
            await updateGrid();
          } catch (err) {
            alert("Failed to update customer.");
            console.error(err);
          }
        }
      };

      // Reset Customer PIN button functionality
      const resetPinBtn = document.getElementById("reset-pin-btn");
      resetPinBtn.onclick = async () => {
        if (!activeCustomer) return;
        if (!confirm("Reset customer's PIN? This will require them to create a new PIN on login.")) return;
        try {
          await db.collection("customers").doc(activeCustomer.id).update({ pin: "" });
          activeCustomer.pin = "";
          document.getElementById("profile-pin").textContent = "";
          alert("Customer PIN has been reset. They must create a new PIN to log in.");
          await populateSidebar();
          openCustomer(activeCustomer.id);
        } catch (error) {
          alert("Failed to reset PIN.");
          console.error(error);
        }
      };

      function updateBatchBar() {
        if (selectedCustomerIds.size > 0) {
          batchBar.classList.add("show");
        } else {
          batchBar.classList.remove("show");
        }
      }

      batchClearBtn.onclick = () => {
        selectedCustomerIds.clear();
        updateBatchBar();
        renderInvoiceGridColors();
        populateSidebar();
        hideEmailOptionsDropdown();
      };

      batchPaidBtn.onclick = async () => {
        if (selectedCustomerIds.size === 0) return;
        batchBar.classList.remove("show");
        if (!confirm("Mark all unpaid for selected?")) return;
        const bills = await getBills();
        const batch = db.batch();
        bills
          .filter((b) => selectedCustomerIds.has(b.customerId) && !b.paid)
          .forEach((b) => batch.update(db.collection("bills").doc(b.id), { paid: true }));
        await batch.commit();
        selectedCustomerIds.clear();
        await updateMetrics();
        await updateGrid();
        updateBatchBar();
        hideEmailOptionsDropdown();
      };

      batchEmailBtn.onclick = () => {
        if (selectedCustomerIds.size === 0) return;
        showEmailOptionsDropdown();
      };

      // Email options dropdown handlers
      function showEmailOptionsDropdown() {
        emailOptionsDropdown.classList.add("show");
      }
      function hideEmailOptionsDropdown() {
        emailOptionsDropdown.classList.remove("show");
      }
      closeEmailOptionsBtn.onclick = () => {
        hideEmailOptionsDropdown();
      };

      async function sendNewCustomerEmail() {
        const customers = await getCustomers();
        const toSend = customers.filter((c) => selectedCustomerIds.has(c.id));
        const mailtoLinks = toSend.map(c => {
          const subject = encodeURIComponent("Welcome to Customer Portal");
          const body = encodeURIComponent(`Hello ${c.name},

Please create your login PIN at the customer portal using this link: [INSERT_PORTAL_LINK]

Thank you!`);
          return `mailto:${c.email}?subject=${subject}&body=${body}`;
        });
        for (const mailto of mailtoLinks) {
          window.open(mailto);
        }
        hideEmailOptionsDropdown();
      }
      async function sendNewInvoiceEmail() {
        const customers = await getCustomers();
        const toSend = customers.filter((c) => selectedCustomerIds.has(c.id));
        const mailtoLinks = toSend.map(c => {
          const subject = encodeURIComponent("Your Invoice is Ready");
          const body = encodeURIComponent(`Hello ${c.name},

Your new invoice is available to view. Please log in to your customer portal.

Thank you!`);
          return `mailto:${c.email}?subject=${subject}&body=${body}`;
        });
        for (const mailto of mailtoLinks) {
          window.open(mailto);
        }
        hideEmailOptionsDropdown();
      }

      emailNewCustomerBtn.onclick = () => sendNewCustomerEmail();
      emailNewInvoiceBtn.onclick = () => sendNewInvoiceEmail();

      // Login flow
      loginBtn.onclick = async () => {
        pinError.textContent = "";
        if (pinInput.value === "1234") {
          loginBtnText.classList.add("hidden");
          loginBtnSpinner.classList.remove("hidden");
          loginBtn.disabled = true;
          try {
            await populateSidebar();
            await updateMetrics();
            await updateGrid();
            loginOverlay.classList.add("hidden");
            sidebar.classList.remove("hidden");
            main.classList.remove("hidden");
            document.querySelector('.nav-link[data-target="dashboard"]').classList.add("active");
            showSection("dashboard");
          } finally {
            loginBtnText.classList.remove("hidden");
            loginBtnSpinner.classList.add("hidden");
            loginBtn.disabled = false;
            pinInput.value = "";
          }
        } else {
          pinError.textContent = "Invalid PIN";
        }
      };

      async function updateMetrics() {
        const customers = await getCustomers();
        const validCustomers = customers.filter(c =>
          c.id && c.id.trim() !== "" &&
          ((c.name && c.name.trim() !== "") || (c.email && c.email.trim() !== ""))
        );

        const bills = await getBills();
        document.getElementById("customersCount").textContent = validCustomers.length;

        const unpaid = bills.filter((b) => !b.paid);
        document.getElementById("outstandingCount").textContent = unpaid.length;
        document.getElementById("unpaidAmount").textContent =
          "$" + unpaid.reduce((s, b) => s + b.amount, 0).toFixed(2);

        const now = new Date(),
          m = now.getMonth(),
          y = now.getFullYear();

        const revenue = bills
          .filter(
            (b) =>
              b.paid &&
              new Date(b.dueDate).getMonth() === m &&
              new Date(b.dueDate).getFullYear() === y
          )
          .reduce((s, b) => s + b.amount, 0);

        document.getElementById("revenueCount").textContent = "$" + revenue.toFixed(2);
      }

      async function updateGrid() {
        const customers = await getCustomers();
        invoiceGrid.innerHTML = "";
        // SORT customers by numeric ID ascending BEFORE rendering
        customers.sort((a, b) => +a.id - +b.id);
        customers.forEach((c) => {
          const cell = document.createElement("div");
          cell.className = "grid-cell";
          cell.textContent = c.id;
          cell.setAttribute("data-customer-id", c.id);
          invoiceGrid.appendChild(cell);
        });
        renderInvoiceGridColors();
        attachGridLongPressHandlers();
      }

      async function renderInvoiceGridColors() {
        const bills = await getBills();

        document.querySelectorAll("#invoice-grid .grid-cell").forEach((cell) => {
          const cid = cell.getAttribute("data-customer-id");
          const custBills = bills.filter((b) => b.customerId === cid);
          const hasUnpaid = custBills.some((b) => !b.paid);
          if (hasUnpaid) {
            cell.classList.add("red");
            cell.classList.remove("green");
          } else {
            cell.classList.add("green");
            cell.classList.remove("red");
          }
          cell.classList.toggle("selected", selectedCustomerIds.has(cid));
        });
      }

      let longPressTimer = null;
      const longPressDuration = 600;

      function attachGridLongPressHandlers() {
        document.querySelectorAll("#invoice-grid .grid-cell").forEach((cell) => {
          cell.onpointerdown = (e) => {
            e.preventDefault();
            const customerId = cell.getAttribute("data-customer-id");
            longPressTimer = setTimeout(() => {
              toggleCustomerSelection(customerId);
            }, longPressDuration);
          };
          cell.onpointerup = () => {
            clearTimeout(longPressTimer);
            longPressTimer = null;
          };
          cell.onpointerleave = () => {
            clearTimeout(longPressTimer);
            longPressTimer = null;
          };
          cell.onclick = (e) => {
            e.preventDefault();
            if (!longPressTimer) toggleCustomerSelection(cell.getAttribute("data-customer-id"));
          };
        });
      }

      function toggleCustomerSelection(customerId) {
        if (selectedCustomerIds.has(customerId)) selectedCustomerIds.delete(customerId);
        else selectedCustomerIds.add(customerId);
        updateBatchBar();
        renderInvoiceGridColors();
        hideEmailOptionsDropdown();
      }

      await populateSidebar();
      await updateMetrics();
      await updateGrid();
    });
  </script>
</body>
</html>
